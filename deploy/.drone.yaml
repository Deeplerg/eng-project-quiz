---
kind: pipeline
type: kubernetes
name: wip-cicd

steps:
  - name: build-push
    image: gcr.io/kaniko-project/executor:debug
    environment:
      USERNAME:
        from_secret: registry_username
      PASSWORD:
        from_secret: registry_password
      REGISTRY:
        from_secret: registry_address
      CA_CERT:
        from_secret: registry_ca_cert
    commands:
      - exit # temporary to speed up pipeline
      - printf '%b\n' "$CA_CERT" > "/kaniko/ssl/certs/additional-ca-cert-bundle.crt"
      
      - COMMIT=${DRONE_COMMIT_SHA:0:8}
      - RAW_BRANCH=${DRONE_BRANCH}
      - BRANCH=$(echo $RAW_BRANCH | sed 's/[^a-zA-Z0-9]/-/g')
      - TAG=$BRANCH-$COMMIT
      - FULL_IMAGE_NAME=$REGISTRY/quizapp:$TAG
        
      - AUTH=$(echo -n $USERNAME:$PASSWORD | base64)
      
      - |
        JSON="{ \"auths\": { \"$REGISTRY\": { \"auth\": \"$AUTH\" } } }"
      - echo $JSON > "/kaniko/.docker/config.json"

      - /kaniko/executor --destination="$FULL_IMAGE_NAME" --context="." --dockerfile="/deploy/Dockerfile.QuizApp" --cache="true" --cache-repo="$REGISTRY/quizapp/cache" --cache-copy-layers="true" --cache-run-layers="true"

  - name: clone-infrastructure
    image: alpine/git
    commands:
      - git clone https://github.com/Deeplerg/eng-project-quiz-infra
  
  - name: edit-kustomization
    image: registry.k8s.io/kustomize/kustomize:v5.0.0
    environment:
      CERT_MANAGER_ISSUER:
        from_secret: kustomize_wip-cicd_cert_manager_issuer
      INGRESS_CLASS_NAME:
        from_secret: kustomize_wip-cicd_ingress_class_name
      INGRESS_TLS_HOST:
        from_secret: kustomize_wip-cicd_ingress_tls_host
      INGRESS_TLS_SECRETNAME:
        from_secret: kustomize_wip-cicd_ingress_tls_secretname
      INGRESS_HOST:
        from_secret: kustomize_wip-cicd_ingress_host
    commands:
      - cd eng-project-quiz-infra/kustomization/wip-cicd
      
      - printf '%b\n' CERT_MANAGER_ISSUER=$CERT_MANAGER_ISSUER > environment-variables.env
      - printf '%b\n' INGRESS_CLASS_NAME=$INGRESS_CLASS_NAME >> environment-variables.env
      - printf '%b\n' INGRESS_TLS_HOST=$INGRESS_TLS_HOST >> environment-variables.env
      - printf '%b\n' INGRESS_TLS_SECRETNAME=$INGRESS_TLS_SECRETNAME >> environment-variables.env
      - printf '%b\n' INGRESS_HOST=$INGRESS_HOST >> environment-variables.env   
      
      - COMMIT=${DRONE_COMMIT_SHA:0:8}
      - RAW_BRANCH=${DRONE_BRANCH}
      - BRANCH=$(echo $RAW_BRANCH | sed 's/[^a-zA-Z0-9]/-/g')
      - TAG=$BRANCH-$COMMIT
      - FULL_IMAGE_NAME=$REGISTRY/quizapp:$TAG

      - kustomize edit set image quizapp-image-name=$FULL_IMAGE_NAME
      - kustomize build .
    

trigger:
  branch:
    - wip-cicd
  events:
    - push
    - rollback